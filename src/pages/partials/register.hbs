<div class="form-group width800">
    <div class="header ">Register your NFT</div>
    <p>Here you can combine the proof a twitter account and a proof Nft ownership</p>
    <div class="field is-grouped">

    </div>
    <div class="field">
        <label class="label">1. Twitter Handle</label>
        <input class="input" type="text" id="twitterHandle" placeholder="@elonmusk" value="{{twitterHandle}}"/>
    </div>
    <div class="field">
        <label class="label">2. Assets Url</label>
        <div class="control">
            <input type="text" class="input" id="nftAddress" value="{{nftAddress}}"
                   placeholder="https://opensea.io/assets/0x76be3b62873462d2142405439777e971754e8e77/10089">
        </div>
    </div>
    <div class="field" id="mm-section" style="display:none">
        <div class="label">3. Login with metaMask</div>
        <button class="button is-link" id="mmLoginBtn">Login with Metamask</button>
        <div class="col-" id="usersAddress"></div>
    </div>

    <div class="field" id="sign-section" style="display:none">
        <div class="label">4. Sign Message to prove NFT ownership</div>
        <input type="text" class="input" id="messageToSign"/>
        <br>
        <button class="button" id="signBtn">Sign Message</button>
        <div class="label">Signature</div>
        <input type="text" class="input" id="signature"></div>
</div>


<div class="field" id="twitter-section" style="display:none">
    <div class="label">5. Tweet using the button below to proof twitter account</div>
    <button onclick="onTweet">Tweet</button>
</div>
</div>

<script type="text/javascript">

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelector("#mmLoginBtn").addEventListener("click", bindConnectMM);
        document.querySelector("#signBtn").addEventListener("click", onSign);
        document.querySelector("#twitterHandle").addEventListener("input", validateFrom);
        document.querySelector("#nftAddress").addEventListener("input", validateFrom);
    });

    let messageToSign = "";
    let account = "";
    let web;

    async function bindConnectMM() {
        if (typeof window.ethereum === "undefined") {
            console.log("MetaMask is not installed!");
            return;
        }

        const accounts = await ethereum.request({ method: "eth_requestAccounts" });
        account = accounts[0];
        web3 = new Web3(window.ethereum);

        let twitterHandle = document.querySelector("#twitterHandle").value;
        document.querySelector("#usersAddress").value = account;
        messageToSign = `{"twitterHandle":"${twitterHandle}"}`;
        document.querySelector("#messageToSign").value = messageToSign;
        document.querySelector("#sign-section").style.display = "block";
    }

    async function onSign() {
        if (!messageToSign) {
            return;
        }
        const signData = JSON.stringify(messageToSign);
        const signature = await window.web3.eth.personal.sign(signData, account);
        document.querySelector("#signature").value = signature;

        const result = await fetch(
                "https://3fwuxfbnhf.execute-api.us-east-2.amazonaws.com/dev/createPendingRequest",
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        signature: signature,
                        json: document.querySelector("#messageToSign").value,
                        openseaUrl: document.querySelector("#nftAddress").value
                    })
                });

        console.log("result", result);
        document.querySelector("#twitter-section").style.display = "block";

    }

    function validateFrom() {
        let twitterHandle = document.querySelector("#twitterHandle").value;
        let nftAddress = document.querySelector("#nftAddress").value;
        if (twitterHandle.length > 0 && nftAddress.length > 0) {
            document.querySelector("#mm-section").style.display = "block";
        }
    }

    function onFormValid() {

        btn.style.display = "block";
        btn.addEventListener("click", () => {
            let twitterHandle = document.querySelector("#twitterHandle").value;
            let nftAddress = document.querySelector("#nftAddress").value;
            let signature = document.querySelector("#signature").value;
        });
    }

    function onTweet() {

        window.open(`https://twitter.com/intent/tweet?text=Iâ€™m verifying that I own ${document.querySelector("#nftAddress").value} #nftidverify`);

        const intervalId = setInterval(async () => {

            const result = await fetch(
                    `https://3fwuxfbnhf.execute-api.us-east-2.amazonaws.com/dev/fetchVerifiedRequest?openseaUrl=${document.querySelector("#nftAddress").value}`,
                    {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json"
                        }
                    });

            if (result.body) {
                console.log("DONE");
                clearInterval(intervalId);
            }

        }, 5000);

    }

</script>
